<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserve Any | ROI診断レポート</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --navy: #1f3864; --gold-bg: #fffdef; --accent-red: #c00000; --light-gray: #f8f9fa; --creation-blue: #0070c0; }
        
        body { font-family: "游ゴシック", "Yu Gothic", sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { width: 850px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        header { background: var(--navy); color: white; padding: 25px; text-align: center; margin-bottom: 30px; border-radius: 4px; }
        h1 { margin: 0; font-size: 26px; letter-spacing: 3px; }
        h2 { font-size: 18px; color: var(--navy); border-left: 6px solid var(--navy); padding-left: 15px; margin: 30px 0 15px 0; }
        
        .client-section { margin-bottom: 30px; display: flex; align-items: center; border-bottom: 2px solid var(--navy); padding-bottom: 8px; }
        .client-name { border: none; font-size: 1.4em; width: 100%; outline: none; font-weight: bold; background: transparent; }
        
        .task-list { background: var(--gold-bg); padding: 15px; border: 1px solid #e0d8b0; border-radius: 8px; }
        .task-item { display: flex; align-items: flex-start; margin-bottom: 10px; cursor: pointer; font-size: 13.5px; }
        .task-item input { width: 18px; height: 18px; margin-right: 12px; margin-top: 2px; flex-shrink: 0; }
        
        .calc-grid { display: grid; grid-template-columns: 330px 1fr; gap: 30px; margin-top: 20px; }
        .input-group { margin-bottom: 18px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #555; }
        
        .rate-inputs { background: #f1f4f9; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #d0d7e5; }
        .rate-label { font-size: 12px; color: var(--navy); font-weight: bold; display: block; margin-bottom: 10px; text-align: center; }
        
        input[type="range"] { width: 100%; accent-color: var(--navy); }
        input[type="number"], select { width: 85px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        select { width: 100%; }
        .num-wrap { display: flex; justify-content: flex-end; align-items: center; gap: 5px; margin-top: 5px; }

        .spec-box { background: var(--light-gray); padding: 12px; border-radius: 6px; border: 1px solid #eee; margin-top: 10px; font-size: 13px; text-align: center; line-height: 1.6;}
        
        .result-side { display: flex; flex-direction: column; gap: 15px; }
        .chart-box { background: #fff; border: 1px solid #f0f0f0; padding: 12px; border-radius: 6px; position: relative; }
        .chart-title { font-size: 11px; font-weight: bold; color: var(--navy); margin-bottom: 5px; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        .canvas-wrapper { height: 100px; position: relative; }

        .summary-box { border: 2px solid var(--navy); padding: 15px; border-radius: 8px; background: #fff; position: relative; }
        .res-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .res-val { font-weight: bold; font-size: 1.1em; }
        .total-saving { border-top: 2px dashed #eee; padding-top: 10px; color: var(--creation-blue); margin-top: 5px; }
        .roi-badge { position: absolute; top: -12px; right: 20px; background: var(--accent-red); color: white; padding: 4px 15px; font-size: 13px; font-weight: bold; border-radius: 20px; }

        .solution-area { background: #fff; border: 1px solid var(--navy); padding: 25px; border-radius: 8px; }
        .sol-item { font-size: 14px; margin-bottom: 25px; line-height: 1.6; border-bottom: 1px dotted #ccc; padding-bottom: 15px; }
        .sol-item:last-child { border-bottom: none; }
        .sol-title { color: var(--navy); font-weight: bold; font-size: 16px; display: block; margin-bottom: 8px; }

        .footer-note { font-size: 11px; color: #888; margin-top: 30px; text-align: center; }
        .print-btn { background: var(--navy); color: white; border: none; padding: 18px; width: 100%; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 30px; font-size: 17px; transition: opacity 0.3s; }
        .print-btn:disabled { opacity: 0.6; cursor: wait; }

        /* ▼▼▼ ログイン画面用CSS ▼▼▼ */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1f3864; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 8px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 300px;
        }
        .login-box h3 { margin-top: 0; color: #1f3864; }
        .login-input {
            width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc;
            border-radius: 4px; box-sizing: border-box; font-size: 16px; text-align: center;
        }
        .login-btn {
            background: #c00000; color: white; border: none; padding: 10px 20px;
            border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; transition: opacity 0.3s;
        }
        .login-btn:disabled { opacity: 0.6; cursor: wait; }
        .login-error { color: red; font-size: 12px; margin-top: 10px; display: none; }
        
        /* ログイン後に誰が使っているか表示するエリア */
        .user-display {
            position: absolute; top: 10px; right: 20px; color: white; font-size: 12px; opacity: 0.8;
        }
        /* ▲▲▲ ログイン画面用CSS ▲▲▲ */

        @media print { 
            @page { size: A4 portrait; margin: 10mm; }
            body { background: white; padding: 0; }
            .container { box-shadow: none; width: 100%; padding: 0; margin: 0; }
            .print-btn, input[type="range"], .user-display { display: none !important; }
            #section-phase3 { break-before: page; page-break-before: always; padding-top: 20px; }
            #loginOverlay { display: none !important; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h3>RESERVE ANY LOGIN</h3>
        <p style="font-size:12px; color:#666;">社員IDを入力してください</p>
        <input type="text" id="idInput" class="login-input" placeholder="User ID">
        <button id="loginBtn" class="login-btn" onclick="executeLogin()">ログイン</button>
        <div id="loginError" class="login-error">IDが見つかりません</div>
    </div>
</div>
<div class="container">
    <header>
        <h1>OFFICE OPTIMIZATION ROI REPORT</h1>
        <div class="user-display">User: <span id="headerUserName"></span></div>
    </header>

    <div class="client-section">
        <span style="white-space:nowrap; margin-right:15px; font-size: 14px; font-weight: bold;">FOR CLIENT:</span>
        <input type="text" class="client-name" id="clientNameInput" placeholder="貴社名を入力してください">
    </div>

    <section id="section-phase1">
        <h2>Phase 01 | 運用課題の選択</h2>
        <div class="task-list">
            <label class="task-item"><input type="checkbox" class="task-check" onchange="calc()" checked><span>【ミスマッチ】広い会議室を1～2名で占有し、定員不一致が常態化している</span></label>
            <label class="task-item"><input type="checkbox" class="task-check" onchange="calc()"><span>【偏り・独り占め】部署別ランキングやジニ係数(独占指標)が把握できていない</span></label>
            <label class="task-item"><input type="checkbox" class="task-check" onchange="calc()" checked><span>【隙間時間】予約の合間の空き時間を集約し、利用枠を再創出したい</span></label>
            <label class="task-item"><input type="checkbox" class="task-check" onchange="calc()"><span>【将来投資】客観的な利用ログに基づき、増床・削減の判断をしたい</span></label>
        </div>
    </section>

    <section id="section-phase2">
        <h2>Phase 02 | オフィス条件・コストシミュレーション</h2>
        <div class="calc-grid">
            <div class="calc-inputs">
                <div class="input-group">
                    <label>所在地（23区単価目安）</label>
                    <select id="tanka" onchange="calc()">
                        <option value="42000">港区 (4.2万円)</option>
                        <option value="40000">千代田区 (4.0万円)</option>
                        <option value="38000">渋谷区 (3.8万円)</option>
                        <option value="32000" selected>中央区 (3.2万円)</option>
                        <option value="30000">新宿区 (3.0万円)</option>
                        <option value="26000">品川区 (2.6万円)</option>
                        <option value="24000">目黒区 (2.4万円)</option>
                        <option value="22000">豊島区 (2.2万円)</option>
                        <option value="15000">その他平均 (1.5万円)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>会議室数 (4坪/室)</label>
                    <input type="range" id="roomSlide" min="0" max="50" value="10" oninput="roomCount.value=this.value; calc()">
                    <div class="num-wrap"><input type="number" id="roomCount" value="10" oninput="roomSlide.value=this.value; calc()"> <small>室</small></div>
                </div>
                <div class="input-group">
                    <label>個室ブース数 (0.5坪/室)</label>
                    <input type="range" id="boothSlide" min="0" max="50" value="4" oninput="boothCount.value=this.value; calc()">
                    <div class="num-wrap"><input type="number" id="boothCount" value="4" oninput="boothSlide.value=this.value; calc()"> <small>室</small></div>
                </div>
                <div class="input-group">
                    <label>対象従業員数 (ID数)</label>
                    <input type="range" id="idSlide" min="10" max="1000" step="10" value="100" oninput="idCount.value=this.value; calc()">
                    <div class="num-wrap"><input type="number" id="idCount" value="100" oninput="idSlide.value=this.value; calc()"> <small>名</small></div>
                </div>
                <div class="rate-inputs">
                    <span class="rate-label">稼働率シミュレーション</span>
                    <div style="margin-bottom:12px;">
                        <label style="font-size:11px;">現状の稼働率 (%)</label>
                        <input type="range" id="beforeSlide" min="10" max="90" value="60" oninput="beforeVal.value=this.value; calc()">
                        <div class="num-wrap"><input type="number" id="beforeVal" value="60" oninput="beforeSlide.value=this.value; calc()"> <small>%</small></div>
                    </div>
                    <div>
                        <label style="font-size:11px;">導入後の目標稼働率 (%)</label>
                        <input type="range" id="afterSlide" min="10" max="100" value="75" oninput="afterVal.value=this.value; calc()">
                        <div class="num-wrap"><input type="number" id="afterVal" value="75" oninput="afterSlide.value=this.value; calc()"> <small>%</small></div>
                    </div>
                </div>
                <div class="spec-box">
                    <div>月間の資産維持費(合計面積)：</div>
                    <strong><span id="dispTotalOffice">0</span> 円</strong>
                </div>
            </div>

            <div class="result-side">
                <div class="chart-box">
                    <div class="chart-title">Reserve Any 利用料 vs 利用価値の創出額 (円)</div>
                    <div class="canvas-wrapper"><canvas id="costChart"></canvas></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">正味の月間コスト回収額 (円)</div>
                    <div class="canvas-wrapper"><canvas id="netChart"></canvas></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">月間有効時間の変化 (h)</div>
                    <div class="canvas-wrapper"><canvas id="hourChart"></canvas></div>
                </div>
                <div class="summary-box">
                    <div class="roi-badge">ROI: <span id="roiPercent">0</span>%</div>
                    <div class="res-row"><span>新しく創出される月間有効時間:</span><span class="res-val" id="dispHour" style="color:var(--navy)">0 h</span></div>
                    <div class="res-row total-saving">
                        <span style="font-weight:bold;">正味の資産コスト回収効果(月):</span>
                        <span class="res-val" id="dispNetSaving">0</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="section-phase3">
        <h2>Phase 03 | Reserve Any 導入効果</h2>
        <div class="solution-area"><div id="solList"></div></div>
        <div style="margin-top:20px; font-size:11px; color:#666; line-height:1.4;">
            <strong>【算出根拠】</strong><br>
            ・創出価値：稼働率向上により、支払っている家賃コストから新たに引き出される「有効な会議・集中時間」を金額換算したもの。<br>
            ・正味のコスト回収効果：創出価値から Reserve Any 利用料を差し引いた、実質的なコストパフォーマンス改善額。
        </div>
        <footer class="footer-note">
            作成日: <span id="currentDate"></span> | Reserve Any ROI Optimization Report
        </footer>
    </section>

    <button class="print-btn" onclick="handlePrintAndSave()">レポートをPDF保存・印刷</button>
</div>

<script>
    // ==========================================
    // ▼ 設定エリア (GAS URLはそのまま)
    // ==========================================
    const scriptURL = "https://script.google.com/macros/s/AKfycbxIMvCBunw_-vTzrxbdykVTjIBPeTrNF414iS3YRIJUE7BgwuhL695DY5b38wYuv7RK/exec";
    // ==========================================

    let costChart, netChart, hourChart;

    // ▼ ログイン実行 (GASに問い合わせる)
    async function executeLogin() {
        const idInput = document.getElementById('idInput').value;
        const btn = document.getElementById('loginBtn');
        const errorMsg = document.getElementById('loginError');

        if(!idInput) return;

        // UIを「確認中」に変更
        btn.innerText = "確認中...";
        btn.disabled = true;
        errorMsg.style.display = 'none';

        try {
            // GASにIDを送信して名前を取得 (GETリクエスト)
            const response = await fetch(`${scriptURL}?id=${idInput}`);
            const data = await response.json();

            if (data.result === 'success') {
                // 成功：名前とIDをブラウザに保存して画面を開く
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('userName', data.name);
                sessionStorage.setItem('userId', idInput);
                
                unlockScreen(data.name);
            } else {
                // 失敗：エラー表示
                errorMsg.innerText = "IDが見つかりません";
                errorMsg.style.display = 'block';
                btn.innerText = "ログイン";
                btn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            errorMsg.innerText = "通信エラーが発生しました";
            errorMsg.style.display = 'block';
            btn.innerText = "ログイン";
            btn.disabled = false;
        }
    }

    // 画面のロックを解除して名前を表示
    function unlockScreen(name) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('headerUserName').innerText = name;
    }

    // ページ読み込み時の処理
    document.addEventListener("DOMContentLoaded", function() {
        // すでにログイン済みならスキップ
        if(sessionStorage.getItem('isLoggedIn') === 'true') {
            unlockScreen(sessionStorage.getItem('userName'));
        }
        
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ja-JP');
        initCharts();
        calc();
    });

    // ------------------------------------------
    // ▼ 以下、計算・保存処理 (名前とIDも送信)
    // ------------------------------------------

    const chartDataLabels = {
        id: 'chartDataLabels',
        afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            ctx.save();
            ctx.font = 'bold 10px sans-serif';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            data.datasets[0].data.forEach((value, index) => {
                const { y } = chart.getDatasetMeta(0).data[index];
                let label = value.toLocaleString();
                if (chart.canvas.id !== 'hourChart') label += ' 円';
                else label += ' h';
                ctx.fillText(label, chart.getDatasetMeta(0).data[index].x + 5, y);
            });
        }
    };

    function initCharts() {
        const commonOpt = { 
            indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
            layout: { padding: { right: 80 } }, 
            plugins: { legend: { display: false } }, 
            scales: { x: { beginAtZero: true, grid: { display: false }, ticks: { display: false }, border: { display: false } }, y: { grid: { display: false } } } 
        };
        
        costChart = new Chart(document.getElementById('costChart').getContext('2d'), {
            type: 'bar',
            data: { labels: ['利用料', '創出価値'], datasets: [{ data: [0, 0], backgroundColor: ['#1f3864', '#0070c0'], borderRadius: 4, barThickness: 20 }] },
            options: commonOpt, plugins: [chartDataLabels]
        });

        netChart = new Chart(document.getElementById('netChart').getContext('2d'), {
            type: 'bar',
            data: { labels: ['正味の回収額'], datasets: [{ data: [0], backgroundColor: ['#0070c0'], borderRadius: 4, barThickness: 20 }] },
            options: commonOpt, plugins: [chartDataLabels]
        });

        hourChart = new Chart(document.getElementById('hourChart').getContext('2d'), {
            type: 'bar',
            data: { labels: ['導入前', '目標値'], datasets: [{ data: [0, 0], backgroundColor: ['#d1d5db', '#1f3864'], borderRadius: 4, barThickness: 20 }] },
            options: commonOpt, plugins: [chartDataLabels]
        });
    }

    function calc() {
        const tanka = parseInt(document.getElementById('tanka').value) || 0;
        const rooms = parseInt(document.getElementById('roomCount').value) || 0;
        const booths = parseInt(document.getElementById('boothCount').value) || 0;
        const ids = parseInt(document.getElementById('idCount').value) || 0;
        const bRate = parseInt(document.getElementById('beforeVal').value) / 100;
        const aRate = parseInt(document.getElementById('afterVal').value) / 100;

        const areaT = (rooms * 4) + (booths * 0.5);
        const officeCost = tanka * areaT;
        const toolCost = ids * 450;
        const diffRate = Math.max(0, aRate - bRate);
        const grossSaving = officeCost * diffRate;
        const netSaving = grossSaving - toolCost;
        const roi = toolCost > 0 ? Math.round((grossSaving / toolCost) * 100) : 0;

        const totalMaxHours = (rooms + booths) * 8 * 20;
        const hBefore = Math.floor(totalMaxHours * bRate);
        const hAfter = Math.floor(totalMaxHours * aRate);
        const hDiff = hAfter - hBefore;

        document.getElementById('dispTotalOffice').innerText = officeCost.toLocaleString();
        document.getElementById('dispNetSaving').innerText = netSaving.toLocaleString() + " 円";
        document.getElementById('dispHour').innerText = hDiff.toLocaleString() + " 時間";
        document.getElementById('roiPercent').innerText = roi.toLocaleString();

        if(costChart) {
            costChart.data.datasets[0].data = [toolCost, grossSaving];
            costChart.update();
        }
        if(netChart) {
            netChart.data.datasets[0].data = [netSaving];
            netChart.data.datasets[0].backgroundColor = [netSaving >= 0 ? '#0070c0' : '#c00000'];
            netChart.update();
        }
        if(hourChart) {
            hourChart.data.datasets[0].data = [hBefore, hAfter];
            hourChart.update();
        }

        const checks = document.querySelectorAll('.task-check');
        const solList = document.getElementById('solList');
        solList.innerHTML = '';
        const dynamicMessages = [
            { title: "面積資産の活用価値を最大化", text: `現状の稼働率から${Math.round(aRate*100)}%への最適化により、月間約${grossSaving.toLocaleString()}円相当の「新しい価値」をオフィスから創出します。` },
            { title: "個室・ブースの回転率向上", text: `${booths}台のブース利用を効率化。WEB会議の急増によるブース不足を、Reserve Any の予約集約アルゴリズムで解消します。` },
            { title: `月間${hDiff}時間の会議枠を創出`, text: `増床コストなしで、月間${hDiff}時間分の活動スペースを実質的に生み出します。これは会議室${(hDiff/160).toFixed(1)}室分を増設するのと同等の価値です。` },
            { title: "客観的データに基づく適正化", text: `月間${officeCost.toLocaleString()}円の維持費に対し、Reserve Any のデータを活用して無駄のない拠点運営を実現。将来的な賃料ロスを未然に防ぎます。` }
        ];
        checks.forEach((c, i) => {
            if(c.checked) {
                const d = document.createElement('div');
                d.className = 'sol-item';
                d.innerHTML = `<span class="sol-title">${dynamicMessages[i].title}</span>${dynamicMessages[i].text}`;
                solList.appendChild(d);
            }
        });
    }

    async function handlePrintAndSave() {
        const btn = document.querySelector('.print-btn');
        const originalText = btn.innerText;

        btn.innerText = "データを保存しています...";
        btn.disabled = true;

        const dataToSend = {
            // 保存したユーザー情報を付与
            userId: sessionStorage.getItem('userId') || '不明',
            userName: sessionStorage.getItem('userName') || '不明',
            
            clientName: document.getElementById('clientNameInput').value || "未入力",
            tanka: document.getElementById('tanka').options[document.getElementById('tanka').selectedIndex].text,
            roomCount: document.getElementById('roomCount').value,
            boothCount: document.getElementById('boothCount').value,
            employeeCount: document.getElementById('idCount').value,
            hours: document.getElementById('dispHour').innerText, 
            roi: document.getElementById('roiPercent').innerText + "%", 
            netSaving: document.getElementById('dispNetSaving').innerText,
            location: document.getElementById('tanka').value,
            beforeRate: document.getElementById('beforeVal').value + "%", 
            afterRate: document.getElementById('afterVal').value + "%"
        };

        try {
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            });
            console.log("送信リクエスト完了");
        } catch (error) {
            console.error("保存エラー:", error);
        }

        setTimeout(() => {
            btn.innerText = originalText;
            btn.disabled = false;
            window.print();
        }, 1000); 
    }
</script>
</body>
</html>

