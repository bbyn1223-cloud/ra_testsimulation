<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserve Any | ROI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --navy: #1f3864; 
            --dark-navy: #152745;
            --gold-bg: #fffdef; 
            --accent-red: #c00000; 
            --light-gray: #f4f6f9; 
            --creation-blue: #0070c0; 
            --border-color: #e0e0e0;
        }
        
        body { 
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; 
            background: var(--light-gray); 
            margin: 0; 
            padding: 0; 
            color: #333; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- ヘッダー --- */
        .app-header {
            background: var(--navy);
            color: white;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .app-title { font-size: 18px; font-weight: bold; letter-spacing: 1px; }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-info { font-size: 13px; opacity: 0.9; }
        
        .logout-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: white;
        }

        /* --- メインレイアウト --- */
        .main-wrapper {
            display: flex;
            height: calc(100vh - 60px);
        }

        .left-panel {
            width: 380px;
            background: white;
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--light-gray);
        }

        /* --- 共通スタイル --- */
        h2 { font-size: 15px; color: var(--navy); border-left: 4px solid var(--navy); padding-left: 10px; margin: 0 0 15px 0; }
        
        .panel-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        
        input[type="text"], select, input[type="number"] {
            width: 100%; box-sizing: border-box;
            padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
        }
        input[type="range"] { width: 100%; accent-color: var(--navy); margin: 10px 0; cursor: pointer; }
        
        .num-wrap { display: flex; align-items: center; gap: 5px; justify-content: flex-end; }
        .num-wrap input { width: 80px; text-align: right; }

        .task-list { background: var(--gold-bg); padding: 10px; border: 1px solid #e0d8b0; border-radius: 6px; }
        .task-item { display: flex; margin-bottom: 8px; font-size: 12px; cursor: pointer; }
        .task-item input { margin-right: 8px; margin-top: 2px; }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);
            text-align: center; position: relative;
        }
        .kpi-label { font-size: 12px; color: #888; display: block; margin-bottom: 5px; }
        .kpi-value { font-size: 24px; font-weight: bold; color: var(--navy); }
        .roi-badge {
            position: absolute; top: -10px; right: -10px;
            background: var(--accent-red); color: white;
            padding: 4px 10px; font-size: 12px; font-weight: bold; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-box {
            background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);
            height: 250px;
        }
        .chart-title { font-size: 12px; font-weight: bold; text-align: center; margin-bottom: 10px; color: #555; }
        .canvas-wrapper { height: 200px; position: relative; }

        .sol-item {
            font-size: 13px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed #eee;
            line-height: 1.5;
        }
        .sol-title { color: var(--navy); font-weight: bold; display: block; margin-bottom: 4px; }

        .print-btn {
            background: var(--navy); color: white; border: none; padding: 15px;
            width: 100%; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px;
            transition: background 0.2s;
        }
        .print-btn:hover { background: var(--dark-navy); }
        .print-btn:disabled { opacity: 0.6; cursor: wait; }

        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--navy); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 8px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 320px;
        }
        .login-input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 16px; }
        .login-btn { background: var(--accent-red); color: white; border: none; padding: 12px; width: 100%; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .login-error { color: red; font-size: 12px; margin-top: 10px; display: none; }

        /* 印刷時の注釈（デフォルト非表示） */
        .print-notes { display: none; }

        /* =========================================
           ▼ 印刷設定
           ========================================= */
        @media print {
            @page { 
                size: A4 landscape; 
                margin: 5mm; 
            }
            
            body { 
                height: 100%; 
                width: 100%;
                overflow: hidden; 
                background: white; 
                -webkit-print-color-adjust: exact; 
                zoom: 80%; 
            }
            
            .print-btn, #loginOverlay, input[type="range"] { 
                display: none !important; 
            }
            .no-print-section { display: none !important; }
            .logout-btn, .user-info { display: none !important; }

            .main-wrapper { 
                display: flex !important;
                flex-direction: row !important;
                height: auto !important;
                gap: 20px;
            }

            .app-header {
                position: static;
                height: 50px;
                background: var(--navy) !important;
                color: white !important;
                margin-bottom: 15px;
                border-bottom: none;
                justify-content: center;
            }
            .app-title { font-size: 24px; }
            
            .left-panel { 
                width: 300px !important; 
                flex-shrink: 0;
                border: 2px solid var(--navy) !important;
                background: #f8f9fa !important;
                padding: 15px !important;
                display: block !important;
                border-radius: 8px;
            }
            
            .input-group { 
                margin-bottom: 12px; 
                border-bottom: 1px dotted #ccc; 
                padding-bottom: 4px;
            }
            .input-group label { margin-bottom: 0; color: #555; font-size: 11px; }
            
            input[type="number"], select, input[type="text"] { 
                border: none !important; 
                background: transparent !important; 
                font-weight: bold; 
                font-size: 14px;
                text-align: right;
                padding: 0;
                box-shadow: none;
                appearance: none;
                -webkit-appearance: none;
            }
            .num-wrap { justify-content: flex-end; }
            
            #clientNameInput {
                text-align: left;
                font-size: 22px !important;
                color: var(--navy);
                border-bottom: 2px solid var(--accent-red) !important;
                margin-bottom: 20px;
            }

            .right-panel { 
                flex-grow: 1 !important; 
                padding: 0 !important; 
                background: white !important; 
                border: none; 
                overflow: visible !important; 
            }
            
            .kpi-grid { 
                grid-template-columns: 1fr 1fr 1fr; 
                gap: 15px; 
                margin-bottom: 20px; 
            }
            .kpi-card {
                padding: 10px; 
                border: 1px solid #ddd;
                box-shadow: none;
                background: white;
            }
            .kpi-value { font-size: 24px; }

            .charts-container { 
                grid-template-columns: 1fr 1fr 1fr; 
                gap: 15px; 
                margin-bottom: 20px; 
            }
            .chart-box { 
                height: 200px; 
                padding: 10px; 
                border: 1px solid #ddd; 
            }
            .canvas-wrapper { height: 160px; }

            .panel-card { 
                box-shadow: none; 
                border: 1px solid #ddd; 
                padding: 15px;
            }
            .sol-item { font-size: 11px; }

            /* ▼ 印刷時のみ表示する注釈エリア ▼ */
            .print-notes {
                display: block !important;
                position: fixed;
                bottom: 10px;
                right: 10px;
                width: auto;
                background: rgba(255, 255, 255, 0.9);
                border: 1px solid #ccc;
                padding: 8px 12px;
                font-size: 9px;
                color: #333;
                z-index: 1000;
                text-align: left;
                border-radius: 4px;
                line-height: 1.4;
            }
            .print-notes h4 {
                margin: 0 0 4px 0;
                font-size: 10px;
                color: var(--navy);
                border-bottom: 1px solid #ddd;
            }
            .print-notes ul {
                margin: 0; padding-left: 15px;
            }
        }

        /* =========================================
           ▼ ツールチップのスタイル調整
           ========================================= */
        .tooltip-container {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted #888;
            display: inline-block;
        }

        .tooltip-container::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: normal;
            width: max-content;
            max-width: 400px;
            text-align: left;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-weight: normal;
            line-height: 1.5;
        }

        .tooltip-container::before {
            content: "";
            position: absolute;
            bottom: 110%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.85) transparent transparent transparent;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .tooltip-container:hover::after,
        .tooltip-container:hover::before {
            opacity: 1;
            visibility: visible;
            bottom: 100%;
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h3 style="color:var(--navy); margin-top:0;">RESERVE ANY</h3>
        <p style="font-size:12px; color:#666;">社員IDでログインしてください</p>
        <input type="text" id="idInput" class="login-input" placeholder="User ID">
        <button id="loginBtn" class="login-btn" onclick="executeLogin()">ログイン</button>
        <div id="loginError" class="login-error">IDが見つかりません</div>
    </div>
</div>

<header class="app-header">
    <div class="app-title">OFFICE OPTIMIZATION DASHBOARD</div>
    <div class="header-right">
        <div class="user-info">Login User: <span id="headerUserName" style="font-weight:bold;">Guest</span></div>
        <button onclick="logout()" class="logout-btn">ログアウト</button>
    </div>
</header>

<div class="main-wrapper">
    
    <div class="left-panel">
        <div style="grid-column: 1 / -1;">
            <label class="no-print-section">対象クライアント名</label>
            <input type="text" id="clientNameInput" placeholder="貴社名を入力" style="font-weight:bold; font-size:16px;">
        </div>

        <section class="no-print-section">
            <h2>01. 運用課題</h2>
            <div class="task-list">
                <label class="task-item"><input type="checkbox" class="task-check" onchange="calc()" checked><span>【ミスマッチ】広い会議室を少人数で利用</span></label>
                <label class="task-item"><input type="checkbox" class="task-check" onchange="calc()"><span>【独占】特定の部署・人が予約を独占</span></label>
                <label class="task-item"><input type="checkbox" class="task-check" onchange="calc()" checked><span>【隙間時間】予約間の15-30分が無駄</span></label>
                <label class="task-item"><input type="checkbox" class="task-check" onchange="calc()"><span>【データ不足】増床判断の根拠がない</span></label>
            </div>
        </section>

        <section>
            <h2>02. 算出前提条件</h2>
            
            <div class="input-group">
                <label>エリア単価 (円/坪)</label>
                <div class="num-wrap" style="justify-content: space-between;">
                    <select id="tanka" onchange="calc()">
                        <option value="42000">港区 (4.2万)</option>
                        <option value="40000">千代田区 (4.0万)</option>
                        <option value="38000">渋谷区 (3.8万)</option>
                        <option value="32000" selected>中央区 (3.2万)</option>
                        <option value="30000">新宿区 (3.0万)</option>
                        <option value="26000">品川区 (2.6万)</option>
                        <option value="24000">目黒区 (2.4万)</option>
                        <option value="22000">豊島区 (2.2万)</option>
                        <option value="15000">その他 (1.5万)</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label>会議室数 (4坪/室)</label>
                <div class="num-wrap">
                    <input type="number" id="roomCount" value="10" oninput="roomSlide.value=this.value; calc()"> 室
                </div>
                <input type="range" id="roomSlide" min="0" max="50" value="10" oninput="roomCount.value=this.value; calc()">
            </div>

            <div class="input-group">
                <label>個室ブース数 (0.5坪/室)</label>
                <div class="num-wrap">
                    <input type="number" id="boothCount" value="4" oninput="boothSlide.value=this.value; calc()"> 台
                </div>
                <input type="range" id="boothSlide" min="0" max="50" value="4" oninput="boothCount.value=this.value; calc()">
            </div>

            <div class="input-group">
                <label>従業員数 (ID数)</label>
                <div class="num-wrap">
                    <input type="number" id="idCount" value="100" oninput="idSlide.value=this.value; calc()"> 名
                </div>
                <input type="range" id="idSlide" min="10" max="1000" step="10" value="100" oninput="idCount.value=this.value; calc()">
            </div>

            <div class="input-group">
                <label>稼働率改善 (現在→目標)</label>
                <div class="num-wrap">
                    <span style="font-size:12px; font-weight:bold;"><span id="dispBefore">60%</span> → <span id="dispAfter">75%</span></span>
                </div>
                <input type="range" id="beforeSlide" min="10" max="90" value="60" oninput="updateRateLabel(); calc()">
                <input type="range" id="afterSlide" min="10" max="100" value="75" oninput="updateRateLabel(); calc()">
                <input type="hidden" id="beforeVal" value="60">
                <input type="hidden" id="afterVal" value="75">
            </div>
            
            <div class="input-group" style="border-top:1px dashed #ccc; padding-top:5px; margin-top:5px;">
                 <label>月間資産維持費</label>
                 <strong><span id="dispTotalOffice" class="tooltip-container" data-tooltip="（会議室総面積 ＋ ブース総面積）× エリア坪単価">0</span> 円</strong>
            </div>
        </section>
        
        <button class="print-btn" onclick="handlePrintAndSave()">レポート保存・印刷</button>
    </div>

    <div class="right-panel">
        
        <div class="kpi-grid">
            <div class="kpi-card" style="border: 2px solid var(--accent-red); background:#fff5f5;">
                <span class="roi-badge">ROI: <span id="roiPercent" class="tooltip-container" data-tooltip="コスト回収メリット ÷ ツール利用料 × 100">0</span>%</span>
                <span class="kpi-label">月間コスト回収メリット</span>
                <span class="kpi-value tooltip-container" id="dispNetSaving" style="color:var(--accent-red)" data-tooltip="スペース活用価値 － ツール利用料（ID数×450円）">0</span>
                <span style="font-size:12px;">円 / 月</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">創出される有効時間</span>
                <span class="kpi-value tooltip-container" id="dispHour" style="color:var(--creation-blue)" data-tooltip="総可能稼働時間（室数×8h×20日） × 稼働率改善ポイント">0</span>
                <span style="font-size:12px;">時間 / 月</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">スペース資産活用価値</span>
                <span class="kpi-value tooltip-container" id="dispGrossSaving" data-tooltip="月間資産維持費 × （目標稼働率 － 現状稼働率）">0</span>
                <span style="font-size:12px;">円 / 月</span>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-box">
                <div class="chart-title">費用対効果</div>
                <div class="canvas-wrapper"><canvas id="costChart"></canvas></div>
            </div>
            <div class="chart-box">
                <div class="chart-title">月間収支</div>
                <div class="canvas-wrapper"><canvas id="netChart"></canvas></div>
            </div>
            <div class="chart-box">
                <div class="chart-title">有効時間の増加</div>
                <div class="canvas-wrapper"><canvas id="hourChart"></canvas></div>
            </div>
        </div>

        <section class="solution-section panel-card">
            <h2>03. 導入効果レポート</h2>
            <div id="solList"></div>
            <div style="margin-top:20px; font-size:11px; color:#888; text-align:right;">
                作成日: <span id="currentDate"></span> | Reserve Any ROI System
            </div>
        </section>

    </div>
</div>

<div class="print-notes">
    <h4>【算出根拠一覧】</h4>
    <ul>
        <li><strong>月間資産維持費:</strong> （会議室総面積 ＋ ブース総面積）× エリア坪単価</li>
        <li><strong>スペース資産活用価値:</strong> 月間資産維持費 × （目標稼働率 － 現状稼働率）</li>
        <li><strong>コスト回収メリット:</strong> スペース活用価値 － ツール利用料（ID数×450円）</li>
        <li><strong>ROI (投資対効果):</strong> コスト回収メリット ÷ ツール利用料 × 100</li>
        <li><strong>創出される有効時間:</strong> 総可能稼働時間 × 稼働率改善ポイント</li>
        <li><strong>会議室増設換算:</strong> 創出時間 ÷ 160時間（1室の月間最大稼働時間 8h×20日）</li>
    </ul>
</div>

<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycby9qhaxmrnlF3LYA3vuoI0RPYFHwbTasdwL5bvibaNH7WkKHU56j1FxwYKtfUzCI2I4/exec";

    let costChart, netChart, hourChart;

    function updateRateLabel() {
        const b = document.getElementById('beforeSlide').value;
        const a = document.getElementById('afterSlide').value;
        document.getElementById('beforeVal').value = b;
        document.getElementById('afterVal').value = a;
        document.getElementById('dispBefore').innerText = b + "%";
        document.getElementById('dispAfter').innerText = a + "%";
    }

    function logout() {
        sessionStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('userName');
        sessionStorage.removeItem('userId');
        location.reload();
    }

    async function executeLogin() {
        const idInput = document.getElementById('idInput').value;
        const btn = document.getElementById('loginBtn');
        const errorMsg = document.getElementById('loginError');

        if(!idInput) {
            errorMsg.innerText = "IDを入力してください";
            errorMsg.style.display = 'block';
            return;
        }

        btn.innerText = "確認中...";
        btn.disabled = true;
        errorMsg.style.display = 'none';

        try {
            const response = await fetch(`${scriptURL}?id=${idInput}`);
            const data = await response.json();

            if (data.result === 'success') {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('userName', data.name);
                sessionStorage.setItem('userId', idInput);
                unlockScreen(data.name);
            } else {
                errorMsg.innerText = "IDが見つかりません";
                errorMsg.style.display = 'block';
                btn.innerText = "ログイン";
                btn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            errorMsg.innerText = "通信エラー";
            errorMsg.style.display = 'block';
            btn.innerText = "ログイン";
            btn.disabled = false;
        }
    }

    function unlockScreen(name) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('headerUserName').innerText = name;
    }

    document.addEventListener("DOMContentLoaded", function() {
        if(sessionStorage.getItem('isLoggedIn') === 'true') {
            unlockScreen(sessionStorage.getItem('userName'));
        }
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ja-JP');
        
        try {
            initCharts();
        } catch(e) {
            console.error("Chart init error:", e);
        }
        calc();
    });

    const chartDataLabels = {
        id: 'chartDataLabels',
        afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            ctx.save();
            ctx.font = 'bold 10px sans-serif';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            data.datasets[0].data.forEach((value, index) => {
                const { x, y } = chart.getDatasetMeta(0).data[index];
                if(x && y) {
                    let label = value.toLocaleString();
                    ctx.fillText(label, x, y - 2);
                }
            });
        }
    };

    function initCharts() {
        const commonOpt = { 
            responsive: true, maintainAspectRatio: false, 
            plugins: { legend: { display: false } }, 
            scales: { y: { beginAtZero: true, grid: { color: '#f0f0f0' } }, x: { grid: { display: false } } } 
        };
        
        costChart = new Chart(document.getElementById('costChart').getContext('2d'), {
            type: 'bar',
            data: { labels: ['利用料', '創出価値'], datasets: [{ data: [0, 0], backgroundColor: ['#1f3864', '#0070c0'], borderRadius: 4, barThickness: 30 }] },
            options: commonOpt, plugins: [chartDataLabels]
        });

        netChart = new Chart(document.getElementById('netChart').getContext('2d'), {
            type: 'bar',
            data: { labels: ['正味の回収額'], datasets: [{ data: [0], backgroundColor: ['#0070c0'], borderRadius: 4, barThickness: 30 }] },
            options: commonOpt, plugins: [chartDataLabels]
        });

        hourChart = new Chart(document.getElementById('hourChart').getContext('2d'), {
            type: 'bar',
            data: { labels: ['導入前', '目標値'], datasets: [{ data: [0, 0], backgroundColor: ['#d1d5db', '#1f3864'], borderRadius: 4, barThickness: 30 }] },
            options: commonOpt, plugins: [chartDataLabels]
        });
    }

    function calc() {
        const tanka = parseInt(document.getElementById('tanka').value) || 0;
        const rooms = parseInt(document.getElementById('roomCount').value) || 0;
        const booths = parseInt(document.getElementById('boothCount').value) || 0;
        const ids = parseInt(document.getElementById('idCount').value) || 0;
        const bRate = parseInt(document.getElementById('beforeVal').value) / 100;
        const aRate = parseInt(document.getElementById('afterVal').value) / 100;

        const areaT = (rooms * 4) + (booths * 0.5);
        const officeCost = tanka * areaT;
        const toolCost = ids * 450;
        const diffRate = Math.max(0, aRate - bRate);
        const grossSaving = officeCost * diffRate;
        const netSaving = grossSaving - toolCost;
        const roi = toolCost > 0 ? Math.round((grossSaving / toolCost) * 100) : 0;

        const totalMaxHours = (rooms + booths) * 8 * 20;
        const hBefore = Math.floor(totalMaxHours * bRate);
        const hAfter = Math.floor(totalMaxHours * aRate);
        const hDiff = hAfter - hBefore;

        document.getElementById('dispTotalOffice').innerText = officeCost.toLocaleString();
        document.getElementById('dispNetSaving').innerText = netSaving.toLocaleString();
        document.getElementById('dispGrossSaving').innerText = grossSaving.toLocaleString();
        document.getElementById('dispHour').innerText = hDiff.toLocaleString();
        document.getElementById('roiPercent').innerText = roi.toLocaleString();

        if(costChart) {
            costChart.data.datasets[0].data = [toolCost, grossSaving];
            costChart.update();
        }
        if(netChart) {
            netChart.data.datasets[0].data = [netSaving];
            netChart.data.datasets[0].backgroundColor = [netSaving >= 0 ? '#c00000' : '#888']; 
            if(netSaving > 0) netChart.data.datasets[0].backgroundColor = ['#c00000']; 
            netChart.update();
        }
        if(hourChart) {
            hourChart.data.datasets[0].data = [hBefore, hAfter];
            hourChart.update();
        }

        const checks = document.querySelectorAll('.task-check');
        const solList = document.getElementById('solList');
        solList.innerHTML = '';
        const dynamicMessages = [
            { title: "面積資産の活用価値を最大化", text: `現状の稼働率から${Math.round(aRate*100)}%への最適化により、月間約${grossSaving.toLocaleString()}円相当の「新しい価値」をオフィスから創出します。` },
            { title: "個室・ブースの回転率向上", text: `${booths}台のブース利用を効率化。WEB会議の急増によるブース不足を、Reserve Any の予約集約アルゴリズムで解消します。` },
            
            // ▼ 変更点：ここにもツールチップ用HTMLを埋め込みました
            { title: `月間${hDiff}時間の会議枠を創出`, text: `増床コストなしで、月間${hDiff}時間分の活動スペースを実質的に生み出します。これは会議室<span class="tooltip-container" data-tooltip="創出時間 ÷ 160時間（1室の月間最大稼働時間 8h×20日）">${(hDiff/160).toFixed(1)}室分</span>を増設するのと同等の価値です。` },
            
            { title: "客観的データに基づく適正化", text: `月間${officeCost.toLocaleString()}円の維持費に対し、Reserve Any のデータを活用して無駄のない拠点運営を実現。将来的な賃料ロスを未然に防ぎます。` }
        ];
        checks.forEach((c, i) => {
            if(c.checked) {
                const d = document.createElement('div');
                d.className = 'sol-item';
                d.innerHTML = `<span class="sol-title">${dynamicMessages[i].title}</span>${dynamicMessages[i].text}`;
                solList.appendChild(d);
            }
        });
    }

    async function handlePrintAndSave() {
        const btn = document.querySelector('.print-btn');
        const originalText = btn.innerText;
        btn.innerText = "保存中...";
        btn.disabled = true;

        const dataToSend = {
            userId: sessionStorage.getItem('userId') || '不明',
            userName: sessionStorage.getItem('userName') || '不明',
            clientName: document.getElementById('clientNameInput').value || "未入力",
            tanka: document.getElementById('tanka').options[document.getElementById('tanka').selectedIndex].text,
            roomCount: document.getElementById('roomCount').value,
            boothCount: document.getElementById('boothCount').value,
            employeeCount: document.getElementById('idCount').value,
            hours: document.getElementById('dispHour').innerText, 
            roi: document.getElementById('roiPercent').innerText + "%", 
            netSaving: document.getElementById('dispNetSaving').innerText,
            location: document.getElementById('tanka').value,
            beforeRate: document.getElementById('beforeVal').value + "%", 
            afterRate: document.getElementById('afterVal').value + "%"
        };

        try {
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            });
        } catch (error) {
            console.error("保存エラー:", error);
        }

        setTimeout(() => {
            btn.innerText = originalText;
            btn.disabled = false;
            window.print();
        }, 1000); 
    }
</script>
</body>
</html>
